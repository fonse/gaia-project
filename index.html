<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gaia Project Board Generator</title>
  <style>
    body {
      margin: 0;
      padding: 10px 0 0;
    }

    #grid {
      margin: auto;
      display: none;
    }

    .spinner {
      display: flex;
      width: 100%;
      justify-content: center;
      height: 30vh;
      margin-top: 35vh;
    }

    .vertical {
      transform: rotate(90deg) scale(1.25);
      transform-origin: 0 0;
      position: relative;
      left: 97.5%;
    }
  </style>
</head>
<body>
  
  <div class="spinner">
    <img src="static/spinner.svg" alt="Generating...">
  </div>
  <div id="grid"></div>

  <script src="static/svg.min.js"></script>
  <script src="static/honeycomb.min.js"></script>
  
  <script>
    /**
     * -------------------------------------------------------
     * Constants
     * -------------------------------------------------------
     */
    const hexSize = 40;
    const Hex = Honeycomb.extendHex({
        size: hexSize,
        orientation: 'flat',
    });
    const Grid = Honeycomb.defineGrid(Hex);
    
    const planetSize = hexSize;
    const planetColors = {
      'terra': '#2080f0',
      'desert': '#f2ff00',
      'swamp': '#704100',
      'oxide': '#ff160a',
      'volcanic': '#ff9500',
      'ice': '#f8fff5',
      'titanium': '#6c757d',
      'transdim': '#a64dff',
      'gaia': '#00aa00',
    };


    /**
     * -------------------------------------------------------
     * Rendering Functions
     * -------------------------------------------------------
     */
    
    const draw = SVG().addTo('#grid').size('100%', '100%');
    function render(grid) {
      // Begin render
  
      // Reusable hexagon
      const hexSymbol = draw.symbol()
          .polygon(Hex().corners().map(({ x, y }) => `${x},${y}`))
          .fill('#212529')
          .stroke({ width: 1, color: '#999' })
  
      // Render tile
      grid.forEach(hex => {
        const { x: baseX, y: baseY } = hex.toPoint()
        const x = baseX + hex.tilePositionX * 4;
        const y = baseY - hex.tilePositionY * 4;
        
        const centerX = x + hex.width()/2;
        const centerY = y + hex.height()/2;

        draw.use(hexSymbol).translate(x, y);
        
        if (hex.planet !== 'empty') {
          draw.circle(planetSize).fill(planetColors[hex.planet]).translate(centerX - planetSize/2, centerY - planetSize/2);
        }

        if (hex.isCenter) {
          const text = draw.text(hex.tileNumber)
            .fill('#c0c0c0')
            .font({
              family: 'Helvetica',
              size: 20,
              weight: 'bold',
            });

          text.move(centerX - text.length()/2, centerY - 5);
          text.rotate(hex.rotation * 60, centerX, centerY);

          draw.polygon('0,5 10,5 5,0')
            .fill('#c0c0c0')
            .move(centerX - 5, centerY - 15)
            .rotate(hex.rotation * 60, centerX, centerY);
        }
      })

      resizeGrid();
    }

    function resizeGrid(){
      // Update viewbox
      const bbox = draw.bbox();
      const correctedBbox = {
        x: bbox.x + hexSize * 1.5,
        y: bbox.y,
        width: bbox.width - hexSize * 1.5,
        height: bbox.height
      };
      draw.viewbox(correctedBbox);
  
      // Adjust for vertical screen
      const gridElement = document.getElementById('grid');
      const isVertical = window.innerHeight > window.innerWidth;
      if (isVertical) {
        gridElement.classList.add('vertical');
      } else {
        gridElement.classList.remove('vertical');
        gridElement.style.width = '100%';
        if (gridElement.offsetWidth > correctedBbox.width) {
          gridElement.style.width = `${Math.ceil(correctedBbox.width)}px`;
        }
      }
    }


    /**
     * -------------------------------------------------------
     * Main Logic
     * -------------------------------------------------------
     */

    const worker = new Worker("static/worker.js");
    worker.postMessage(undefined);
    worker.onmessage = (e) => {
      const board = Grid(e.data);

      document.querySelector('.spinner').style.display = 'none';
      document.getElementById('grid').style.display = 'block';
      render(board);
      worker.terminate();
    };

    window.addEventListener('resize', function() {
      resizeGrid();
    });

  </script>
</body>
</html>